<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="view        .btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            color: white;
        }

        .status {th=device-width, initial-scale=1.0">
    <title>SAP Fioneer Download Manager</title>
    <style>
        :root {
            --primary-yellow: #ffcc00;
            --primary-black: #000000;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-light: #e0e0e0;
            --border-focus: #0b6ed1;
            --bg-white: #ffffff;
            --bg-light: #f8f9fa;
            --success-bg: #d4edda;
            --success-text: #155724;
            --success-border: #c3e6cb;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --error-border: #f5c6cb;
        }

        * {
            box-sizing: border-box;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8f9fa;
            color: var(--text-primary);
            line-height: 1.3;
            padding: 40px 20px;
            margin: 0;
            min-height: 100vh;
        }

        .container { 
            background: var(--bg-white);
            padding: 40px;
            border: 1px solid var(--border-light);
            max-width: 280px;
            margin: 0 auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 { 
            color: var(--text-primary);
            font-size: 1.875rem;
            font-weight: 600;
            margin: 0 0 20px 0;
            text-align: center;
        }

                .filename { 
            font-family: monospace; 
            background: var(--bg-light); 
            padding: 8px 12px; 
            border: 1px solid var(--border-light); 
            border-radius: 4px; 
            margin: 12px 0; 
            color: var(--text-secondary);
            white-space: nowrap;
            overflow-x: auto;
            max-width: 100%;
        }

        .btn { 
            width: auto;
            padding: .5rem 1rem;
            background: var(--primary-yellow);
            color: var(--primary-black);
            border: none;
            border-radius: 2rem;
            cursor: pointer;
            font-weight: 400;
            font-size: .875rem;
            font-family: "BentonSans Medium", sans-serif;
            margin: 16px 0;
            transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
            text-transform: none;
            display: inline-flex;
            line-height: 1.375rem;
            text-decoration: none;
            vertical-align: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        .btn:hover { 
            background: var(--primary-black);
            color: white;
        }

        .btn:disabled { 
            background: #6c757d;
            cursor: not-allowed;
            color: white;
        }

        .btn-secondary {
            background: var(--accent-primary);
            color: var(--text-primary);
            border: none;
        }

        .btn-secondary:hover {
            background: var(--text-primary);
            color: white;
        }

        .status { 
            padding: 12px 16px;
            margin: 16px 0;
            display: none;
            border: 1px solid;
        }

        .status.loading {
            background: var(--bg-light);
            color: var(--text-primary);
            border-color: var(--border-light);
        }

        .status.success { 
            background: var(--success-bg);
            color: var(--success-text);
            border-color: var(--success-border);
        }

        .status.error { 
            background: var(--error-bg);
            color: var(--error-text);
            border-color: var(--error-border);
        }

        .progress-container { 
            margin: 20px 0; 
        }

        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background: var(--border-light); 
            border-radius: 10px; 
            overflow: hidden; 
            border: 1px solid var(--border-light);
        }

        .progress-fill { 
            height: 100%; 
            background: var(--primary-yellow); 
            width: 0%; 
            transition: width 0.3s; 
        }

        .progress-text { 
            margin-top: 8px; 
            font-size: 0.875rem; 
            color: var(--text-secondary);
        }

        .spinner { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid var(--border-light); 
            border-top: 2px solid var(--primary-yellow); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-right: 8px; 
        }

        .hidden { 
            display: none; 
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Mobile responsive */
        @media (max-width: 640px) {
            body { padding: 20px 16px; }
            .container { padding: 24px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 32px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="169" height="16" fill="none">
                <path fill="#FFD43C" d="M135.827 3.481h-3.282V.283h3.282v3.198Zm0 2.92h-3.282v3.2h3.282V6.4Zm0 6.119h-3.282v3.198h3.282V12.52Zm6.28-12.237h-3.283v3.198h3.283V.283Zm0 6.118h-3.283v3.198h3.283V6.401Zm6.28-6.118h-3.283v3.198h3.283V.283Zm0 6.118h-3.283v3.198h3.283V6.401Zm-6.28 6.118h-3.283v3.198h3.283v-3.198Zm6.28 0h-3.283v3.198h3.283v-3.198ZM156.172.283h-3.282v3.198h3.282V.283Zm0 6.118h-3.282v3.198h3.282V6.401Zm0 6.118h-3.282v3.198h3.282v-3.198Zm6.28-12.236h-3.283v3.198h3.283V.283Zm0 6.118h-3.283v3.198h3.283V6.401Zm6.28-6.118h-3.283v3.198h3.283V.283Z"></path>
                <path fill="#000" d="M6.735 16a8.926 8.926 0 0 1-2.334-.285 7.37 7.37 0 0 1-1.879-.782 6.21 6.21 0 0 1-1.451-1.196A7.979 7.979 0 0 1 0 12.207l2.63-1.526c.44.848 1.033 1.497 1.781 1.948.748.45 1.578.676 2.49.676.815 0 1.478-.146 1.99-.437.51-.292.767-.736.767-1.333 0-.596-.273-1.03-.82-1.343-.546-.312-1.341-.607-2.385-.885-.71-.19-1.408-.39-2.094-.6a7.835 7.835 0 0 1-1.848-.824 4.167 4.167 0 0 1-1.326-1.291C.847 6.069.68 5.405.68 4.598c0-.719.14-1.363.418-1.933a4.18 4.18 0 0 1 1.164-1.45C2.758.819 3.358.517 4.057.31 4.757.103 5.535 0 6.391 0c.857 0 1.545.086 2.193.26a7.42 7.42 0 0 1 1.744.696c.515.291.964.629 1.347 1.012s.717.782 1.003 1.195l-2.412 1.79a4.645 4.645 0 0 0-1.68-1.592 4.443 4.443 0 0 0-2.214-.595c-.772 0-1.304.143-1.696.427-.394.285-.59.658-.59 1.12 0 .61.281 1.064.845 1.363.564.298 1.364.586 2.401.864.703.184 1.396.385 2.078.605.682.22 1.295.507 1.837.86a4.3 4.3 0 0 1 1.316 1.323c.334.529.502 1.19.502 1.983 0 .623-.126 1.217-.376 1.78a4.13 4.13 0 0 1-1.144 1.49c-.511.43-1.166.775-1.963 1.033-.797.257-1.745.386-2.845.386h-.002Zm7.058-.295L19.39.222h3.32l5.597 15.483h-3.529l-1.17-3.438h-5.387l-1.222 3.438h-3.205Zm5.284-5.9h3.717l-1.816-5.25h-.042l-1.858 5.25h-.001Zm11.224 5.9V.284h5.753c.836 0 1.643.066 2.423.198s1.468.383 2.067.752a4.07 4.07 0 0 1 1.431 1.51c.355.638.532 1.465.532 2.483s-.188 1.88-.564 2.528a4.135 4.135 0 0 1-1.498 1.521 6.137 6.137 0 0 1-2.099.748c-.776.132-1.557.198-2.343.198h-2.245v5.483H30.3Zm3.457-8.108h2.38c1.079 0 1.843-.193 2.292-.58.449-.386.674-.957.674-1.71 0-.752-.221-1.273-.663-1.662-.443-.39-1.21-.585-2.303-.585h-2.38v4.537Zm14.01 8.108V.284H58.22v2.838h-6.976v3.753h4.97v2.686h-4.97v6.144h-3.477.001ZM60.08 3.082V.395h3.466v2.687H60.08Zm.02 12.624V4.596h3.425v11.11H60.1Zm11.383.234a7.591 7.591 0 0 1-2.078-.295 5.194 5.194 0 0 1-1.88-.972c-.556-.45-1.008-1.044-1.357-1.78-.348-.736-.522-1.646-.522-2.731s.173-1.999.522-2.742c.348-.743.8-1.34 1.358-1.79a5.16 5.16 0 0 1 1.87-.966 7.532 7.532 0 0 1 4.151 0 5.097 5.097 0 0 1 1.868.966c.554.45 1.006 1.048 1.358 1.79.351.743.528 1.657.528 2.742s-.176 1.996-.528 2.731c-.352.736-.803 1.33-1.358 1.78a5.151 5.151 0 0 1-1.869.972 7.54 7.54 0 0 1-2.062.295h-.001Zm0-2.36c.807 0 1.404-.312 1.79-.937.387-.623.58-1.444.58-2.462 0-.454-.045-.886-.131-1.296a3.28 3.28 0 0 0-.418-1.073 2.104 2.104 0 0 0-.736-.717c-.299-.173-.66-.26-1.085-.26-.829 0-1.436.31-1.823.926-.387.617-.579 1.424-.579 2.421 0 .462.044.9.13 1.317.087.417.227.778.418 1.083.192.305.437.548.736.728.3.18.672.27 1.118.27Zm7.82 2.126V4.596h3.446v1.751c.167-.217.372-.441.616-.671.243-.23.53-.443.856-.636a5.098 5.098 0 0 1 1.102-.478 4.625 4.625 0 0 1 1.363-.189c.501 0 .924.064 1.33.189.407.125.757.316 1.05.575.292.257.52.59.684.996.164.407.245.896.245 1.465v8.108H86.57v-7.04c0-.502-.103-.882-.308-1.139-.206-.257-.552-.387-1.039-.387a2.77 2.77 0 0 0-1.29.316c-.407.21-.802.475-1.185.794v7.456h-3.446Zm18.398.234a7.73 7.73 0 0 1-2.166-.305 5.05 5.05 0 0 1-1.858-.982c-.54-.45-.973-1.044-1.3-1.78-.327-.736-.49-1.64-.49-2.711s.187-1.995.564-2.731c.376-.736.85-1.329 1.42-1.78.57-.451 1.19-.776 1.858-.977.668-.2 1.294-.3 1.879-.3.584 0 1.188.086 1.811.259a4.157 4.157 0 0 1 1.692.946c.504.457.92 1.087 1.248 1.887.327.8.491 1.83.491 3.092v.498h-7.55c.09.916.374 1.569.851 1.958.477.39 1.077.585 1.802.585.682 0 1.319-.136 1.91-.407.592-.27 1.083-.58 1.473-.925l1.326 2.003c-1.344 1.112-2.997 1.669-4.96 1.669Zm2.068-6.856c-.167-1.546-.894-2.32-2.182-2.32-.537 0-1.011.182-1.426.544-.413.364-.688.955-.82 1.776h4.428Zm10.274 6.856a7.738 7.738 0 0 1-2.166-.305 5.045 5.045 0 0 1-1.858-.982c-.54-.45-.973-1.044-1.3-1.78-.327-.736-.491-1.64-.491-2.711s.188-1.995.563-2.731c.376-.736.85-1.329 1.421-1.78a5.56 5.56 0 0 1 1.858-.977 6.57 6.57 0 0 1 1.88-.3c.584 0 1.188.086 1.811.259a4.157 4.157 0 0 1 1.692.946c.505.457.92 1.087 1.248 1.887.327.8.49 1.83.49 3.092v.498h-7.549c.09.916.374 1.569.851 1.958.477.39 1.077.585 1.801.585.682 0 1.319-.136 1.912-.407.591-.27 1.082-.58 1.472-.925l1.326 2.003c-1.344 1.112-2.997 1.669-4.96 1.669h-.001Zm2.068-6.856c-.168-1.546-.894-2.32-2.182-2.32-.537 0-1.011.182-1.426.544-.415.364-.688.955-.819 1.776h4.427Zm5.074 6.623V4.597h3.445v1.862h.021a5.57 5.57 0 0 1 .565-.723 4.1 4.1 0 0 1 .793-.666c.306-.2.663-.366 1.071-.498a4.587 4.587 0 0 1 1.414-.199h.115l-.052 2.981a4.047 4.047 0 0 0-.412-.04 7.791 7.791 0 0 0-.486-.021c-.682 0-1.275.152-1.78.457a4.788 4.788 0 0 0-1.249 1.058v6.897h-3.445v.002Z"></path>
            </svg>
        </div>
        
        <h3>Download now</h3>
        <div class="filename" id="filenameDisplay">Loading...</div>
        
        <div id="downloadForm">
            <button id="downloadBtn" class="btn btn-primary" onclick="startDownload()">
                Start
            </button>
        </div>

        <div id="status" class="status hidden"></div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">0%</div>
        </div>
    </div>

    <script>
        // DOM elements
        const elements = {
            downloadBtn: document.getElementById('downloadBtn'),
            filenameDisplay: document.getElementById('filenameDisplay'),
            status: document.getElementById('status'),
            progressContainer: document.getElementById('progressContainer'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            downloadForm: document.getElementById('downloadForm')
        };

        // Variables to be injected by server
        const accessToken = null; // Will be replaced by server
        const filename = null; // Will be replaced by server

        // Utility functions
        function showStatus(message, type = 'loading', showSpinner = false) {
            elements.status.innerHTML = showSpinner 
                ? `<span class="spinner"></span>${message}`
                : message;
            elements.status.className = `status ${type}`;
            elements.status.classList.remove('hidden');
        }

        function hideStatus() {
            elements.status.classList.add('hidden');
        }

        function updateProgress(percentage, text) {
            elements.progressFill.style.width = `${percentage}%`;
            elements.progressText.textContent = text || `${Math.round(percentage)}%`;
            elements.progressContainer.classList.remove('hidden');
        }

        function hideProgress() {
            elements.progressContainer.classList.add('hidden');
        }

        function setDownloadingState(downloading) {
            elements.downloadBtn.disabled = downloading;
            elements.downloadBtn.textContent = downloading ? 'Downloading...' : 'Start';
        }

        // File save function
        async function saveFile(blob, filename) {
            if (!('showSaveFilePicker' in window)) {
                throw new Error('File System Access API not supported in this browser');
            }

            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                return true;
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Save failed:', err);
                    throw err;
                }
                return false;
            }
        }

        // Progress management
        function getFileId(filename) {
            return btoa(filename).replace(/[/+=]/g, '');
        }

        function saveDownloadProgress(fileId, loaded, total, filename) {
            try {
                localStorage.setItem(`download_${fileId}`, JSON.stringify({
                    loaded, total, filename, timestamp: Date.now()
                }));
            } catch (e) { console.warn('Failed to save progress:', e); }
        }

        function loadDownloadProgress(fileId) {
            try {
                const data = localStorage.getItem(`download_${fileId}`);
                if (data) {
                    const progress = JSON.parse(data);
                    // Clear old progress (older than 24 hours)
                    if (Date.now() - progress.timestamp > 24 * 60 * 60 * 1000) {
                        localStorage.removeItem(`download_${fileId}`);
                        return null;
                    }
                    return progress;
                }
            } catch (e) { console.warn('Failed to load progress:', e); }
            return null;
        }

        function clearDownloadProgress(fileId) {
            try {
                localStorage.removeItem(`download_${fileId}`);
            } catch (e) { console.warn('Failed to clear progress:', e); }
        }

        // Main download function
        async function startDownload() {
            if (!accessToken || !filename) {
                showStatus('Missing token or filename', 'error');
                return;
            }

            const downloadFilename = filename.split('/').pop();
            const downloadUrl = `https://sap-fioneer-download-manager.cfapps.eu10-005.hana.ondemand.com/download?filename=${encodeURIComponent(filename)}`;
            const fileId = getFileId(filename);
            
            let startByte = 0;
            const existingProgress = loadDownloadProgress(fileId);
            
            if (existingProgress && existingProgress.loaded > 0) {
                const resume = confirm(`Found incomplete download (${(existingProgress.loaded / 1024 / 1024).toFixed(1)}MB of ${(existingProgress.total / 1024 / 1024).toFixed(1)}MB). Resume?`);
                if (resume) {
                    startByte = existingProgress.loaded;
                } else {
                    clearDownloadProgress(fileId);
                }
            }

            try {
                setDownloadingState(true);
                hideStatus();
                updateProgress(0, startByte > 0 ? 'Resuming...' : 'Starting...');

                const xhr = new XMLHttpRequest();
                xhr.open('GET', downloadUrl, true);
                xhr.responseType = 'blob';
                xhr.timeout = 600000;
                xhr.setRequestHeader('Accept', 'application/octet-stream');
                xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                
                if (startByte > 0) {
                    xhr.setRequestHeader('Range', `bytes=${startByte}-`);
                }

                let totalSize = existingProgress ? existingProgress.total : 0;
                let loadedSoFar = startByte;

                xhr.addEventListener('progress', (event) => {
                    if (event.lengthComputable) {
                        const currentLoaded = loadedSoFar + event.loaded;
                        totalSize = totalSize || (loadedSoFar + event.total);
                        const percent = (currentLoaded / totalSize) * 100;
                        const loadedMB = (currentLoaded / 1024 / 1024).toFixed(1);
                        const totalMB = (totalSize / 1024 / 1024).toFixed(1);
                        updateProgress(percent, `${Math.round(percent)}% (${loadedMB}MB / ${totalMB}MB)`);
                        
                        if (event.loaded > 1024 * 1024) {
                            saveDownloadProgress(fileId, currentLoaded, totalSize, downloadFilename);
                        }
                    }
                });

                xhr.addEventListener('load', async () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        updateProgress(100, 'Download completed');
                        try {
                            const saved = await saveFile(xhr.response, downloadFilename);
                            if (saved) {
                                showStatus('File downloaded successfully!', 'success');
                                clearDownloadProgress(fileId);
                                setTimeout(() => { hideProgress(); window.close(); }, 3000);
                            } else {
                                showStatus('File not saved.', 'error');
                                setDownloadingState(false);
                            }
                        } catch (err) {
                            showStatus(`Save failed: ${err.message}`, 'error');
                            setDownloadingState(false);
                        }
                    } else {
                        let msg = `Server Error (${xhr.status})`;
                        try {
                            const reader = new FileReader();
                            reader.onload = () => {
                                try {
                                    const errorData = JSON.parse(reader.result);
                                    msg = errorData.message || errorData.error || msg;
                                } catch (e) { /* ignore */ }
                                showStatus(`${msg}`, 'error');
                            };
                            reader.readAsText(xhr.response);
                        } catch (e) {
                            showStatus(`${msg}`, 'error');
                        }
                        setDownloadingState(false);
                    }
                });

                xhr.addEventListener('error', () => {
                    showStatus('Network error occurred', 'error');
                    setDownloadingState(false);
                });

                xhr.addEventListener('timeout', () => {
                    showStatus('Download timed out', 'error');
                    setDownloadingState(false);
                });

                xhr.send();
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                setDownloadingState(false);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            if (!filename) {
                showStatus('No filename specified', 'error');
                return;
            }
            
            if (!accessToken) {
                showStatus('No access token provided', 'error');
                return;
            }

            elements.filenameDisplay.textContent = filename.split('/').pop();
            hideProgress();
            showStatus('Ready to download', 'loading');
        });
    </script>
</body>
</html>